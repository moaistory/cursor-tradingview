//@version=5
strategy("Profit Exit on 2 Consecutive Bearish Candles", overlay=true, margin_long=100, margin_short=100)

// 입력 파라미터
profit_threshold = input.float(0.5, title="수익 임계값 (%)", minval=0.1, step=0.1)
use_atr = input.bool(true, title="ATR 기반 손절가 사용")
atr_multiplier = input.float(2.0, title="ATR 배수", minval=0.5, step=0.1)
atr_length = input.int(14, title="ATR 기간", minval=1)

// ATR 계산
atr_value = ta.atr(atr_length)

// 음봉 판별 (시가 > 종가)
bearish_candle = close < open

// 연속 음봉 카운트
bearish_count = 0
bearish_count := bearish_candle ? bearish_count + 1 : 0

// 포지션 진입 조건 (예: 상승 추세에서)
long_condition = ta.crossover(close, ta.sma(close, 20))

// 포지션 진입
if long_condition
    strategy.entry("Long", strategy.long)
    strategy.exit("Stop Loss", "Long", stop=strategy.position_avg_price - atr_value * atr_multiplier)

// 수익 계산
position_profit_pct = 0.0
if strategy.position_size > 0
    position_profit_pct = (close - strategy.position_avg_price) / strategy.position_avg_price * 100

// 청산 조건: 수익이면서 음봉이 2개 연속
exit_condition = strategy.position_size > 0 and 
                 position_profit_pct >= profit_threshold and 
                 bearish_count >= 2

// 포지션 청산
if exit_condition
    strategy.close("Long", comment="Profit Exit")

// 플롯
plot(strategy.position_avg_price, title="진입가", color=color.blue, linewidth=2)
plot(strategy.position_avg_price - atr_value * atr_multiplier, title="손절가", color=color.red, linewidth=2)

// 배경색 표시
bgcolor(exit_condition ? color.red : na, title="청산 신호", transp=80)

// 테이블로 정보 표시
var table info_table = table.new(position.top_right, 2, 4, bgcolor=color.white, border_width=1)
if barstate.islast
    table.cell(info_table, 0, 0, "포지션", text_color=color.black, bgcolor=color.gray)
    table.cell(info_table, 1, 0, strategy.position_size > 0 ? "Long" : "None", text_color=color.black)
    
    table.cell(info_table, 0, 1, "수익률", text_color=color.black, bgcolor=color.gray)
    table.cell(info_table, 1, 1, str.tostring(position_profit_pct, "#.##") + "%", 
               text_color=position_profit_pct >= 0 ? color.green : color.red)
    
    table.cell(info_table, 0, 2, "연속 음봉", text_color=color.black, bgcolor=color.gray)
    table.cell(info_table, 1, 2, str.tostring(bearish_count), text_color=color.black)
    
    table.cell(info_table, 0, 3, "청산 조건", text_color=color.black, bgcolor=color.gray)
    table.cell(info_table, 1, 3, exit_condition ? "만족" : "불만족", 
               text_color=exit_condition ? color.red : color.green) 